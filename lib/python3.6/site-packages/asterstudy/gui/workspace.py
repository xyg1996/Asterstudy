# -*- coding: utf-8 -*-

# Copyright 2016 EDF R&D
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License Version 3 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, you may download a copy of license
# from https://www.gnu.org/licenses/gpl-3.0.

"""
Workspace
---------

The module implements Workspace for AsterStudy GUI.
See `Workspace` class for mode details.

"""
from itertools import chain

from PyQt5 import Qt as Q

from ..common import connect, font, is_child, load_icon, translate, wrap_html
from . import Entity, Context, Panel, WorkingMode
from . behavior import behavior
from . editionpanel import EditionPanel
from . datafiles import DataFiles, DataFilesSummary
from . dashboard import Dashboard
from . casesview import CasesView
from . datasettings import DataSettings
from . infoview import InfoView
from . runpanel import RunPanel
from . results import Results

__workspace__version__ = '2.0'

def views():
    """
    Get all views managed by Worspace.

    Returns:
        list[int]: Views supported by workspace (see `Context`).
    """
    return [Context.DataSettings, Context.DataFiles,
            Context.Information, Context.Cases, Context.RunPanel]


def view_title(context):
    """
    Get view's title.

    Arguments:
        context (int): Selection context (see `Context`).

    Returns:
        str: View title.
    """
    title = ""
    if context == Context.DataSettings:
        title = translate("Workspace", "Data Settings")
    elif context == Context.DataFiles:
        title = translate("Workspace", "Data Files")
    elif context == Context.Information:
        title = translate("Workspace", "Information")
    elif context == Context.Cases:
        title = translate("Workspace", "Cases")
    elif context == Context.RunPanel:
        title = translate("Workspace", "Run parameters")
    return title


# note: the following pragma is added to prevent pylint complaining
#       about functions that follow Qt naming conventions;
#       it should go after all global functions
# pragma pylint: disable=invalid-name


class Workspace(Q.QWidget):
    """
    `Workspace` is a class that manages main GUI elements of the
    AsterStudy application.

    To access main GUI elements like *Data Settings* or *Edition*
    views, use `view()` method.
    """

    modeChanged = Q.pyqtSignal(int)
    """
    Signal: emitted when workspace is switched between `History` and
    `Case` working modes.

    Arguments:
        mode (int): Working mode (see `WorkingMode`).
    """

    selectionChanged = Q.pyqtSignal(int)
    """
    Signal: emitted when selection is changed.

    Arguments:
        context (int): Selection context (see `Context`).
    """

    popupMenuRequest = Q.pyqtSignal(int, "QPoint")
    """
    Signal: emitted when context popup menu is requested.

    Arguments:
        context (int): Event context (see `Context`).
        point (QPoint): Mouse cursor position.
    """

    itemChanged = Q.pyqtSignal(Entity, str, int)
    """
    Signal: emitted when data item is changed.

    Arguments:
        entity (Entity): Selection entity.
        value (str): New item's value.
        context (int): Selection context (see `Context`).
    """

    itemActivated = Q.pyqtSignal(Entity, int)
    """
    Signal: emitted when data item is activated.

    Arguments:
        entity (Entity): Selection entity.
        context (int): Selection context (see `Context`).
    """

    editModeActivated = Q.pyqtSignal()
    """
    Signal: emitted when application switches from View to Edit mode.
    """

    def __init__(self, astergui, parent=None, tab_position=Q.QTabWidget.West):#标签页位置设置
        """
        Create workspace.

        Arguments:
            parent (Optional[QWidget]): Parent widget. Defaults to
                *None*.
            tab_position (Optional[QTabWidget.TabPosition]): Position
                of tab pages. Defaults to QTabWidget.West (left,
                vertical).
        """
        Q.QWidget.__init__(self, parent)

        self.astergui = astergui
        self.pages = {}
        self.panels = {}
        self.views = {}

        # ##
        # A. Set-up main workspace area as tab widget with two pages
        # ##

        self.main = Q.QTabWidget(self)
        self.main.setSizePolicy(Q.QSizePolicy.Expanding, Q.QSizePolicy.Expanding)
        self.main.setTabPosition(tab_position)
        v_layout = Q.QVBoxLayout(self)
        v_layout.setContentsMargins(0, 0, 0, 0)
        v_layout.addWidget(self.main)

        # A.1. Add "History View" page

        self.pages[WorkingMode.HistoryMode] = Q.QWidget(self.main)
        icon = load_icon("as_pic_historypanel.png")
        title = translate("Workspace", "History View") #修改标签页标题
        self.main.addTab(self.pages[WorkingMode.HistoryMode], icon, title)

        # A.2. Add "Case View" page

        self.pages[WorkingMode.CaseMode] = Q.QWidget(self.main)
        icon = load_icon("as_pic_casepanel.png")
        title = translate("Workspace", "Case View")
        self.main.addTab(self.pages[WorkingMode.CaseMode], icon, title)

        # A.3. Add "Results View" page
        self.pages[WorkingMode.ResultsMode] = Q.QWidget(self.main)
        self.main.addTab(self.pages[WorkingMode.ResultsMode],
                         load_icon("as_pic_casepanel.png"),
                         translate("Workspace", "Results"))
        self.main.setTabEnabled(WorkingMode.ResultsMode, False)

        # ##
        # B. Set-up "History View" page
        # ##

        # B.1. Add top-level horizontal splitter

        self.history_splitter = Q.QSplitter(Q.Qt.Horizontal, self.pages[WorkingMode.HistoryMode])
        self.history_splitter.setChildrenCollapsible(False)
        self.history_splitter.setContentsMargins(0, 0, 0, 0)
        v_layout = Q.QVBoxLayout(self.pages[WorkingMode.HistoryMode])
        v_layout.setContentsMargins(2, 3, 2, 3)
        v_layout.addWidget(self.history_splitter)

        # B.2. Add vertical splitter to horizontal splitter (split left area vertically)

        self.history_lsplitter = Q.QSplitter(Q.Qt.Vertical, self.history_splitter)
        self.history_lsplitter.setContentsMargins(0, 0, 0, 0)
        self.history_lsplitter.setHandleWidth(5)
        self.history_lsplitter.setChildrenCollapsible(False)
        self.history_splitter.addWidget(self.history_lsplitter)

        # B.2.1. Add "Cases" view to vertical splitter (top-left area)

        self.views[Context.Cases] = CasesView(astergui, self.history_lsplitter)
        self.history_lsplitter.addWidget(self.views[Context.Cases])
        self.history_lsplitter.setStretchFactor(self.history_lsplitter.count()-1, 1)

        # B.2.2. Add "Data Files Summary" view to vertical splitter (middle-left area)

        self.views[Context.DataFilesSummary] = DataFilesSummary(astergui, self.history_lsplitter)
        self.history_lsplitter.addWidget(self.views[Context.DataFilesSummary])
        self.history_lsplitter.setStretchFactor(self.history_lsplitter.count()-1, 1)

        # B.2.3. Add "Run parameters" view to vertical splitter (bottom-left area)

        self.views[Context.RunPanel] = RunPanel(astergui, self.history_lsplitter)
        self.history_lsplitter.addWidget(self.views[Context.RunPanel])

        # B.3. Add "Dashboard" view to horizontal splitter (right area)

        self.views[Context.Dashboard] = Dashboard(astergui, self.history_splitter)
        self.history_splitter.addWidget(self.views[Context.Dashboard])
        self.history_splitter.setStretchFactor(self.history_splitter.count()-1, 1)

        # ##
        # C. Set-up "Case View" page.
        # ##

        v_layout = Q.QVBoxLayout(self.pages[WorkingMode.CaseMode])
        v_layout.setContentsMargins(2, 3, 2, 3)
        v_layout.setSpacing(3)

        # C.1. Add "read-only" banner to the top-most area of page

        self.banner = Q.QLabel(self.pages[WorkingMode.CaseMode])
        self.banner.setObjectName("read_only_banner")
        self.banner.setFrameStyle(Q.QLabel.Box | Q.QLabel.Sunken)
        self.banner.setBackgroundRole(Q.QPalette.ToolTipBase)
        self.banner.setAutoFillBackground(True)
        self.banner.setAlignment(Q.Qt.AlignCenter)
        self.banner.linkActivated.connect(self.editModeActivated)
        v_layout.addWidget(self.banner)

        # C.2. Add top-level horizontal splitter

        self.case_splitter = Q.QSplitter(Q.Qt.Horizontal, self.pages[WorkingMode.CaseMode])
        self.case_splitter.setChildrenCollapsible(False)
        self.case_splitter.setContentsMargins(0, 0, 0, 0)
        v_layout.addWidget(self.case_splitter, 10)

        # C.3. Add vertical splitter to horizontal splitter (split left area vertically)

        self.case_lsplitter = Q.QSplitter(Q.Qt.Vertical, self.case_splitter)
        self.case_lsplitter.setContentsMargins(0, 0, 0, 0)
        self.case_lsplitter.setChildrenCollapsible(False)
        self.case_lsplitter.setHandleWidth(5)
        self.case_splitter.addWidget(self.case_lsplitter)

        # C.4. Add "Data Settings" view (top-left area)

        self.views[Context.DataSettings] = DataSettings(astergui, self.case_lsplitter)
        self.case_lsplitter.addWidget(self.views[Context.DataSettings])

        # C.5. Add "Data Files" view (middle-left area)

        self.views[Context.DataFiles] = DataFiles(astergui, self.case_lsplitter)
        self.case_lsplitter.addWidget(self.views[Context.DataFiles])

        # C.6. Add "Information" view to vertical splitter (bottom-left area)

        self.views[Context.Information] = InfoView(astergui, self.case_lsplitter)
        self.case_lsplitter.addWidget(self.views[Context.Information])

        # C.7. Set-up "View" panel within horizontal splitter (central area)

        self.panels[Panel.View] = astergui.createMeshView(self.case_splitter)
        self.panels[Panel.View].is_on = True
        self.case_splitter.addWidget(self.panels[Panel.View])
        self.case_splitter.setStretchFactor(self.case_splitter.count()-1, 5)

        # C.8. Set-up "Edition" panel (right area)

        self.panels[Panel.Edit] = EditionPanel(self.case_splitter)
        self.case_splitter.addWidget(self.panels[Panel.Edit])
        self.case_splitter.setStretchFactor(self.case_splitter.count()-1, 1)

        # C.9. Set-up "Results" page

        self.results_hboxlayout = Q.QHBoxLayout(self.pages[WorkingMode.ResultsMode])
        self.views[Context.Results] = Results(astergui,
                                              self.pages[WorkingMode.ResultsMode])
        self.results_hboxlayout.addWidget(self.views[Context.Results])

        connect(self.main.currentChanged, self.modeChanged)
        connect(self.main.currentChanged, self._updateBanner)
        connect(self.main.currentChanged, self._selectActiveCase)
        connect(self.panels[Panel.Edit].editorClosed, self.views[Context.Information].update)

        for view in self.views.values():
            view.setContextMenuPolicy(Q.Qt.CustomContextMenu)
            connect(view.customContextMenuRequested, self._popupMenuRequest)
            if hasattr(view, "itemSelectionChanged"):
                connect(view.itemSelectionChanged, self._selectionChanged)
            if hasattr(view, "itemDoubleClicked"):
                connect(view.itemDoubleClicked, self._itemActivated)
            if hasattr(view, "itemChanged"):
                connect(view.itemChanged, self._itemChanged)
            if hasattr(view, "entityChanged"):
                connect(view.entityChanged, self.itemChanged)

        for win in self._windows():
            win.installEventFilter(self)

        self.setFocusPolicy(Q.Qt.StrongFocus)
        self.activate(False)


    def activate(self, enable):
        """
        Activate/deactivate workspace.

        Arguments:
            enable (bool): *True* to activate, *False* to deactivate.
        """
        self.main.setVisible(enable)

    def workingMode(self):
        """
        Get current working mode.

        Returns:
            int: Working mode (see `WorkingMode`).
        """
        return self.main.currentIndex()

    def setWorkingMode(self, mode):
        """
        Set current working mode.

        Arguments:
            mode (int): Working mode (see `WorkingMode`).
        """
        self.main.setCurrentIndex(mode)

    def setTabPosition(self, tab_position):
        """
        Set tab pages position.

        Arguments:
            tab_position (QTabWidget.TabPosition): Tab pages position.
        """
        self.main.setTabPosition(tab_position)

    def view(self, context):
        """
        Get view window.

        Arguments:
            context (int): View type (see `Context`).

        Returns:
            QWidget: View window.
        """
        return self.views.get(context)

    def isViewAvailable(self, context):
        """
        Check if given view is available in current working mode.

        Arguments:
            context (int): View type (see `Context`).

        Returns:
            bool: *True* if view is available in current working mode;
            *False* otherwise.
        """
        panels = {
            WorkingMode.HistoryMode: [Context.Cases, Context.Dashboard,
                                      Context.RunPanel],
            WorkingMode.CaseMode: [Context.DataSettings, Context.DataFiles,
                                   Context.Information],
            WorkingMode.ResultsMode : [Context.Results]
            }
        return context in panels[self.workingMode()]

    def panel(self, panel):
        """
        Get panel.

        Arguments:
            panel (int): Panel type (see `Panel`).

        Returns:
            QWidget: Panel.
        """
        return self.panels.get(panel)

    def saveState(self):
        """
        Save state of workspace's layout.

        Returns:
            str: String representation of layout state, suitable for storage in
            preference file.
        """
        history_hdata = self.history_splitter.saveState().toBase64()
        history_ldata = self.history_lsplitter.saveState().toBase64()
        case_hdata = self.case_splitter.saveState().toBase64()
        case_ldata = self.case_lsplitter.saveState().toBase64()
        case_cdata = self.panels[Panel.View].saveState().toBase64()
        data = []
        fmt_string = '{}={}'
        data.append(fmt_string.format('version', __workspace__version__))
        data.append(fmt_string.format('history_hdata', history_hdata))
        data.append(fmt_string.format('history_ldata', history_ldata))
        data.append(fmt_string.format('case_hdata', case_hdata))
        data.append(fmt_string.format("case_ldata", case_ldata))
        data.append(fmt_string.format("case_cdata", case_cdata))
        return Q.QByteArray(';'.join(data).encode())

    def restoreState(self, state):
        """
        Restore state of workspace's layout.

        Arguments:
            state (str): String representation of layout state.
        """
        if not state:
            return
        state = state.split(';')
        data = {}
        for item in state:
            value = item.split('=')
            if len(value) > 1:
                data[str(value[0])] = value[1]
        if 'history_hdata' in data:
            self.history_splitter.restoreState(Q.QByteArray.fromBase64(data['history_hdata']))
        if 'history_ldata' in data:
            self.history_lsplitter.restoreState(Q.QByteArray.fromBase64(data['history_ldata']))
        if 'case_hdata' in data:
            self.case_splitter.restoreState(Q.QByteArray.fromBase64(data['case_hdata']))
        if 'case_vdata' in data:
            self.case_lsplitter.restoreState(Q.QByteArray.fromBase64(data['case_vdata']))
        if 'case_ldata' in data:
            self.case_lsplitter.restoreState(Q.QByteArray.fromBase64(data['case_ldata']))
        if 'case_cdata' in data:
            self.panels[Panel.View].restoreState(Q.QByteArray.fromBase64(data['case_cdata']))

    def ensureVisible(self, context, entity, select=False):
        """
        Make the entity visible in the given widget.

        Arguments:
            context (int): Selection context (see `Context`).
            entity (Entity): Selection entity.
            select (Optional[bool]): Flag pointing that item should be
                also selected. Defaults to *False*.
        """
        view = self.view(context)
        if view is None:
            return
        if context in (Context.Cases, Context.Dashboard):
            self.setWorkingMode(WorkingMode.HistoryMode)
        else:
            self.setWorkingMode(WorkingMode.CaseMode)
        view.setFocus()
        if context == Context.DataSettings:
            view.ensureVisible(entity, select)
        elif context == Context.Cases:
            view.ensureVisible(entity, select)
        elif context == Context.Dashboard:
            view.ensureVisible(entity, select)

    def expand(self, context, entity):
        """
        Expand given entity.

        Arguments:
            context (int): Selection context (see `Context`).
            entity (Entity): Selection entity.
        """
        view = self.view(context)
        if view is None:
            return
        if context == Context.DataSettings:
            view.expand(entity)

    def selected(self, context):
        """
        Get current selection.

        Arguments:
            context (int): Selection context (see `Context`).

        Returns:
            list[Entity]: Selected items.
        """
        result = []
        view = self.view(context)
        if context == Context.DataSettings:
            result = view.selection()
        elif context == Context.Dashboard:
            result = view.selection()
        elif context == Context.DataFiles:
            result = view.selection()
        elif context == Context.DataFilesSummary:
            pass
        elif context == Context.Information:
            pass
        elif context == Context.Cases:
            result = view.selection()
        elif context == Context.RunPanel:
            result = view.selection()
        return result

    def setSelected(self, context, sellist):
        """
        Sets current selection.

        Arguments:
            context (int): Selection context (see `Context`).
            sellist (list[Entity]): Selected items.
        """
        view = self.view(context)
        if context == Context.DataSettings:
            view.setSelection(sellist)
        elif context == Context.Dashboard:
            view.setSelection(sellist)
        elif context == Context.DataFiles:
            view.setSelection(sellist)
        elif context == Context.Information:
            view.setSelection(sellist)
        elif context == Context.Cases:
            view.setSelection(sellist)
        elif context == Context.RunPanel:
            view.setSelection(sellist)
        elif context == Context.DataFilesSummary:
            view.setSelection(sellist)

    def edit(self, context, entity):
        """
        Enter edition mode for given *entity*.

        Arguments:
            context (int): Selection context (see `Context`).
            entity (Entity): Selection entity.
        """
        if context in (Context.Dashboard, Context.RunPanel):
            context = Context.Cases
        view = self.view(context)
        if context in (Context.DataSettings, Context.Cases):
            self.ensureVisible(context, entity, True)
            view.edit(entity)

    def updateViews(self):
        """Update views."""
        if self.astergui.study() is not None:
            # Update Read-only banner
            self._updateBanner()

            # Show/hide "Read-only" banner
            show_banner = behavior().show_readonly_banner
            cc_active = self.astergui.study().isCurrentCase()
            self.banner.setVisible(show_banner and not cc_active)

            # Update "Data Settings" view
            datasettings = self.view(Context.DataSettings)
            if datasettings is not None:
                datasettings.update()

            # Update "Data Files" view
            file_model = self.astergui.study().dataFilesModel()
            if file_model is not None:
                file_model.update()

            # Update "Dashboard" view
            dashboard = self.view(Context.Dashboard)
            if dashboard is not None:
                dashboard.update()

            # Update "Cases" view
            casesview = self.view(Context.Cases)
            if casesview is not None:
                casesview.update()

            # Update "Data Files Summary" view
            dfs = self.view(Context.DataFilesSummary)
            if dfs is not None:
                dfs.update()

            # Update "Run parameters" view
            runview = self.view(Context.RunPanel)
            if runview is not None:
                runview.update()

            # Update "Information" view
            infoview = self.view(Context.Information)
            if infoview is not None:
                infoview.update()

    def meshViewEnabled(self):
        """
        Check if mesh view is enabled.

        Returns:
            bool: *True* if mesh view is enabled; *False* otherwise.
        """
        return self.panels[Panel.View].is_on

    def setMeshViewEnabled(self, is_on):
        """
        Enable / disable mesh view.

        Arguments:
            is_on (bool): *True* to enable mesh view; *False* to disable it.
        """
        self.panels[Panel.View].setVisible(is_on)
        self.panels[Panel.View].is_on = is_on
        self.astergui.update(actions_only=True)

    # pragma pylint: disable=unused-argument
    def eventFilter(self, obj, event):
        """
        Detect the view and panels hiding event.
        """
        if event.type() in (Q.QEvent.Hide, Q.QEvent.HideToParent,
                            Q.QEvent.Show, Q.QEvent.ShowToParent):
            self._transferFocus()
        return False

    @Q.pyqtSlot("QPoint")
    def _popupMenuRequest(self, pos):
        """
        Called when child widget requests context popup menu.

        Emit `popupMenuRequest(Entity, QPoint)` signal.

        Arguments:
            pos (QPoint): Mouse cursor position.
        """
        sender = self.sender()
        sender.setFocus()
        self.popupMenuRequest.emit(self._context(sender), pos)

    @Q.pyqtSlot(Entity, str)
    def _itemChanged(self, entity, text):
        """
        Called when data item is changed.

        Emit `itemChanged(Entity, str)` signal.

        Arguments:
            item (QTreeWidgetItem): Widget item.
            column (int): Item's column.
        """
        sender = self.sender()
        self.itemChanged.emit(entity, text, self._context(sender))

    @Q.pyqtSlot(Entity)
    def _itemActivated(self, entity):
        """
        Called when data item is activated.

        Emit `itemActivated(Entity)` signal.

        Arguments:
            entity (Entity): Data item being activated.
        """
        sender = self.sender()
        self.itemActivated.emit(entity, self._context(sender))

    @Q.pyqtSlot()
    def _selectionChanged(self):
        """
        Called when selection is changed in a child widget.

        Emits `selectionChanged(int)` signal.
        """
        sender = self.sender()
        self.selectionChanged.emit(self._context(sender))

    @Q.pyqtSlot(int)
    def _selectActiveCase(self, mode):
        """
        Is called when Working mode is changed.
        Selects current case item if nothing was selected before.
        """
        context = None
        if mode == WorkingMode.CaseMode:
            context = Context.DataSettings
        elif mode == WorkingMode.HistoryMode:
            context = Context.Cases

        if context is not None and not self.selected(context):
            self.ensureVisible(context, self.astergui.study().activeCase,
                               True)

    def _windows(self):
        """Returns all views and panels."""
        return chain(self.views.values(), self.panels.values())

    def _transferFocus(self):
        """Move the focus to one of the visible windows."""
        focuswin = None
        curfocus = self.focusWidget()
        win_list = self._windows()
        if curfocus is not None:
            for win in win_list:
                if is_child(curfocus, win):
                    focuswin = win
                    break
            if focuswin is not None and not focuswin.isVisible():
                focuswin = None

        if focuswin is None:
            for win in win_list:
                if win.isVisible():
                    focuswin = win
                    break

            if focuswin is not None:
                focuswin.setFocus()

    def _context(self, widget):
        """
        Get context from widget.

        Arguments:
            widget (QWidget): Workspace's child widget.

        Returns:
            int: Widget's context (see `Context`).
        """
        for context, view in self.views.items():
            if view is widget:
                return context
        return Context.Unknown

    @Q.pyqtSlot(int)
    def _updateBanner(self):
        """
        Update Read-only banner
        """
        txt = translate("AsterStudy",
                        "Read-only (click here to switch back to edit {})")
        case_name = self.astergui.study().history.current_case.name \
            if self.astergui.study() is not None else "<none>"
        txt = txt.format(case_name)
        txt = font(txt, color="red")
        txt = wrap_html(txt, "b")
        txt = wrap_html(txt, "a", href="to_edit_mode")
        txt = wrap_html(txt, "pre")
        self.banner.setText(txt)
